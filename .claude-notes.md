# Claude's Persistent Notes for diplomacy-llm

## Critical Commands & Environment

### Python Environment
- **ALWAYS use `python3`** not `python` (wrong version)
- **ALWAYS activate venv first:** `source venv/bin/activate`
- The venv contains google-generativeai and all dependencies

### Running the Game
```bash
source venv/bin/activate          # Required for python3 commands

# Full season (recommended)
python3 diplomacy.py season       # Runs: plan → turns → reflect

# Individual phases
python3 diplomacy.py plan         # Consider options before diplomacy
python3 diplomacy.py all          # Run turns for all countries
python3 diplomacy.py reflect      # Organize files, submit orders

# Single country
python3 diplomacy.py france       # Run one country's turn
python3 diplomacy.py plan france
python3 diplomacy.py reflect france

# Utilities
python3 diplomacy.py status       # Show game state
python3 diplomacy.py query france "What are your intentions?"  # GM question
python3 diplomacy.py overseer     # Analyze conversations (not in gunboat)
python3 diplomacy.py randomize    # Randomize turn order
python3 diplomacy.py init         # Initialize new game
python3 diplomacy.py cleanup      # Reset all game files
```

## Project Architecture

### File Structure
```
diplomacy-llm/
├── config.yaml              # Game settings, model config, features
├── diplomacy.py             # CLI entry point
├── turn_order.txt           # Persistent turn order
├── src/                     # Python modules
│   ├── agent.py             # DiplomacyAgent class, action parsing
│   ├── orchestrator.py      # Phase execution, season flow
│   ├── context.py           # ContextLoader, builds prompts
│   ├── mode_loader.py       # Prompt loading with mode overlays
│   ├── game_manager.py      # Init/cleanup
│   └── utils.py             # Shared utilities
├── modes/                   # Prompt templates
│   ├── base/                # Default prompts (always loaded)
│   ├── gunboat/             # No-messaging variant
│   └── fow/                 # Fog of war variant
└── countries/               # All game data
    ├── _conversations/      # Shared diplomatic messages
    ├── game_history.md      # Move history (you update this)
    ├── game_state.md        # Current board state, season
    ├── Austria/
    │   ├── void.md          # Scratchpad (cleared periodically)
    │   ├── orders.md        # Current orders
    │   └── *.md             # Agent-created files (strategy, etc.)
    ├── England/
    └── ...
```

### How It Works
- Each country is a separate Gemini LLM session (stateless between turns)
- Context loaded fresh each turn from files
- Season flows: **PLAN** → **TURN** (x N rounds) → **REFLECT**
- User manually adjudicates moves and updates game_history.md

### Action Tags (LLM Output)
```xml
<!-- Send diplomatic message -->
<MESSAGE to="Austria">Your message here</MESSAGE>
<MESSAGE to="Austria,Germany">Group message</MESSAGE>

<!-- File operations (reflect phase) -->
<FILE name="strategy.md" mode="append">New content</FILE>
<FILE name="old_notes.md" mode="edit">Replace entire file</FILE>
<FILE name="obsolete.md" mode="delete"></FILE>

<!-- Quick scratchpad (turn phase) -->
<NOTE>Quick thought to remember</NOTE>
```

Mode aliases: `write`/`overwrite`/`replace`/`create` → `edit`, `add` → `append`

## Key Files

| File | Purpose |
|------|---------|
| `config.yaml` | Features, models, paths, turn settings |
| `countries/game_state.md` | Current season, board state |
| `countries/game_history.md` | Move history (you update this) |
| `countries/*/void.md` | Scratchpad, cleared between seasons |
| `countries/*/orders.md` | Current season's orders |
| `modes/base/*.md` | Prompt templates |

## Configuration

```yaml
# config.yaml
features:
  fog_of_war: false    # Partial visibility
  gunboat: false       # No messaging
  chess: false         # Chess variant (WIP)

model: gemini-3-flash-preview
cheap_model: gemini-3-flash-preview

season:
  turn_rounds: 2       # Messaging rounds before reflect

paths:
  data_dir: countries
  shared_conversations_dir: _conversations
```

## Historical Notes

This project has evolved significantly. Key transitions:

**Nov 2025 (initial):**
- Shell scripts for automation (`run_all_turns.sh`, `reset_game.sh`)
- Fixed file structure: `<PLANS>` and `<NOTES>` tags wrote to `plans.md`/`notes.md`
- Conversations in root `conversations/` folder

**Dec 2025 (v2 refactor):**
- Shell scripts replaced by Python CLI commands
- `<FILE>` tag introduced for flexible file operations
- Data moved to `countries/` directory
- Mode system added (`modes/base/`, `modes/gunboat/`, etc.)
- Modules moved to `src/` package

**Jan 2026:**
- Three-phase season introduced (originally DEBRIEF → TURN → REFLECT)
- `<NOTE>` tag for quick scratchpad
- Emergent behavior experiment: minimal prompts, agents choose own file organization
- DEBRIEF renamed to PLAN: focus on generating multiple strategic options before diplomacy

## Current Status

- Active experiment: multi-option planning (testing if agents adapt better with multiple plans prepared)
- Three-phase season flow: PLAN → TURN → REFLECT
- Research documented in `.claude/research/`
