# Claude's Persistent Notes for diplomacy-llm

## Critical Commands & Environment

### Python Environment
- **ALWAYS use `python3`** not `python` (wrong version)
- **ALWAYS activate venv first:** `source venv/bin/activate`
- The venv contains google-generativeai and all dependencies

### Running the Game
```bash
# Only need to activate venv if running Python directly (git, bash scripts don't need it)
source venv/bin/activate          # Only needed for python3 commands

python3 diplomacy.py <country>    # Run a single country's turn
python3 diplomacy.py readiness    # Check if countries are ready for orders
python3 diplomacy.py orders       # Collect orders from all countries
python3 diplomacy.py status       # Show game status
./run_all_turns.sh                # Run all 7 countries in random order (activates venv automatically)
./reset_game.sh                   # Reset game (clear conversations/plans/notes)
```

## Project Architecture

### File Structure
- `config.yaml` - Game configuration including current_season (user manually updates)
- `game_history.md` - Shared board state (all countries see)
- `conversations/` - Shared diplomatic messages (alphabetically sorted filenames)
- `Austria/`, `England/`, `France/`, etc. - Private plans.md and notes.md per country
- `.env` - API key (gitignored)
- `orders.md` - Generated by `orders` command

### How It Works
- Each country is a separate Gemini LLM session (stateless between turns)
- Context is loaded fresh each turn from files
- LLMs use XML tags to send messages and update files:
  - `<MESSAGE to="Austria">...</MESSAGE>` - Send to one country
  - `<MESSAGE to="Austria,Germany">...</MESSAGE>` - Group chat (supported but not yet used)
  - `<PLANS>...</PLANS>` - Full replacement of plans file
  - `<NOTES>...</NOTES>` - Full replacement of notes file
- User manually adjudicates moves on real board
- User manually updates config.yaml (current_season) and game_history.md between phases

## Key Files
- `config.yaml` - Countries list, paths, model config, **current_season** (user updates this!)
- `context.py` - ContextLoader class, loads all context for a country
- `agent.py` - DiplomacyAgent class, XML parsing, action execution
- `diplomacy.py` - CLI interface (run_country_turn, collect_orders, show_status)
- `initialize_game.py` - Sets up game_history.md with standard starting positions
- `run_all_turns.sh` - Automated script to run all countries in random order
- `reset_game.sh` - Reset game state (keeps config.yaml and game_history.md)

## Implementation Notes

### Conversation Files
- Stored in shared `conversations/` folder
- Filenames are participants in alphabetical order: `Austria-France.md`, `Austria-Germany-Italy.md`
- Each country only sees conversations they're part of
- Organized by season headers: `## Spring 1901`

### Action Parsing
- Regex-based XML tag extraction in agent.py
- Message routing handles both single and multiple recipients
- Plans/notes are full file replacements (not appends)

### Git Setup
- `.gitignore` excludes: `.env`, `venv/`, `conversations/`, plans/notes, `.claude/`
- Game state in config.yaml is tracked (current_season field)
- game_history.md is tracked
- Templates are tracked (game_history_template.md)

## Current Status
✓ All core functionality working
✓ LLMs successfully negotiating and forming alliances
✓ Austria proposing anti-Turkey alliance to Russia and Italy
✓ France-England coordinating on Scandinavia
✓ Russia and Turkey both claiming Black Sea (classic Diplomacy!)
✓ Conversation routing, XML parsing, file updates all working perfectly
✓ Group chat support implemented (not yet used by LLMs)
